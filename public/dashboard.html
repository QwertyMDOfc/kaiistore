<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - KAII STORE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.6s ease-out; }
    .status-pending { @apply bg-yellow-100 text-yellow-800; }
    .status-confirmed { @apply bg-blue-100 text-blue-800; }
    .status-completed { @apply bg-green-100 text-green-800; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8 p-4 bg-white rounded-xl shadow">
      <h1 class="text-2xl font-bold text-purple-800">KAII STORE</h1>
      <div>
        <span id="userName" class="mr-4 text-gray-700"></span>
        <button onclick="logout()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:opacity-90">Logout</button>
      </div>
    </header>

    <!-- Produk -->
    <section id="productsSection" class="mb-12 animate-fade-in">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Produk Tersedia</h2>
      <div id="productsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- Modal Checkout -->
    <div id="checkoutModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-2xl w-full max-w-md p-6 relative">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">&times;</button>
        <h3 class="text-xl font-bold mb-4">Beli Produk</h3>
        <div id="checkoutProductInfo" class="mb-4"></div>
        <form id="checkoutForm">
          <input type="number" id="quantity" min="1" value="1" class="w-full p-2 border rounded mb-4" required />
          <select id="paymentMethod" class="w-full p-2 border rounded mb-4" required></select>
          <button type="submit" class="w-full py-2 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded">Lanjutkan ke Pembayaran</button>
        </form>
      </div>
    </div>

    <!-- Modal Pembayaran -->
    <div id="paymentModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-2xl w-full max-w-md p-6">
        <h3 class="text-xl font-bold mb-4">Pembayaran</h3>
        <div id="paymentDetails" class="mb-4 p-4 bg-gray-50 rounded"></div>
        <form id="proofForm" enctype="multipart/form-data">
          <input type="file" id="proofFile" accept="image/*" class="w-full mb-4" required />
          <button type="submit" class="w-full py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded">Upload Bukti Bayar</button>
        </form>
      </div>
    </div>

    <!-- Riwayat Transaksi -->
    <section class="animate-fade-in">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Riwayat Transaksi</h2>
      <div id="ordersList" class="space-y-4"></div>
    </section>
  </div>

  <script>
    let currentOrderId = null;
    let currentProductId = null;
    let currentUser = null;

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }

    async function api(url, options = {}) {
      const token = localStorage.getItem('token');
      const res = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });
      if (!res.ok) {
        if (res.status === 401) logout();
        throw new Error(await res.text());
      }
      return res.json();
    }

    function formatRupiah(angka) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('id-ID');
    }

    // Load user & data
    async function init() {
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) return logout();
        currentUser = user;
        document.getElementById('userName').textContent = `Halo, ${user.name}`;

        // Load products
        const products = await api('/api/products');
        const productsList = document.getElementById('productsList');
        productsList.innerHTML = products.map(p => `
          <div class="bg-white p-4 rounded-xl shadow hover:shadow-md transition">
            <h3 class="font-bold text-lg">${p.name}</h3>
            <p class="text-gray-600 text-sm mt-1">${p.description || ''}</p>
            <p class="text-purple-700 font-semibold mt-2">${formatRupiah(p.price)}</p>
            <p class="text-gray-500 text-sm">Stok: ${p.stock}</p>
            <button onclick="openCheckout(${p.id}, '${p.name}', ${p.price})" 
              class="mt-3 w-full py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:opacity-90">
              Beli Sekarang
            </button>
          </div>
        `).join('');

        // Load orders
        const orders = await api('/api/my-orders');
        const ordersList = document.getElementById('ordersList');
        if (orders.length === 0) {
          ordersList.innerHTML = '<p class="text-gray-500">Belum ada transaksi.</p>';
        } else {
          ordersList.innerHTML = orders.map(o => `
            <div class="bg-white p-4 rounded-xl shadow">
              <div class="flex justify-between">
                <div>
                  <h4 class="font-bold">${o.product_name}</h4>
                  <p class="text-gray-600">Jumlah: ${o.quantity} Ã— ${formatRupiah(o.total / o.quantity)} = ${formatRupiah(o.total)}</p>
                  <p class="text-sm text-gray-500">Metode: ${o.payment_name}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-xs font-medium ${
                  o.status === 'pending_payment' ? 'bg-gray-100 text-gray-800' :
                  o.status === 'pending_confirmation' ? 'status-pending' :
                  o.status === 'completed' ? 'status-completed' : 'bg-blue-100 text-blue-800'
                }">
                  ${{
                    'pending_payment': 'Menunggu Pembayaran',
                    'pending_confirmation': 'Menunggu Konfirmasi',
                    'processing': 'Diproses',
                    'completed': 'Selesai'
                  }[o.status] || o.status}
                </span>
              </div>
              ${o.proof_image_url ? `<img src="${o.proof_image_url}" class="mt-2 w-24 h-24 object-cover rounded" />` : ''}
              ${o.order_content ? `<div class="mt-2 p-3 bg-green-50 rounded"><strong>Isi Pesanan:</strong><br>${o.order_content}</div>` : ''}
              <p class="text-xs text-gray-400 mt-2">${formatDate(o.created_at)}</p>
            </div>
          `).join('');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function openCheckout(productId, name, price) {
      currentProductId = productId;
      document.getElementById('checkoutProductInfo').innerHTML = `
        <p><strong>${name}</strong></p>
        <p>Harga: ${formatRupiah(price)}</p>
      `;
      
      // Load payment methods
      api('/api/admin/payment-methods').then(methods => {
        const select = document.getElementById('paymentMethod');
        select.innerHTML = methods.filter(m => m.is_active).map(m => 
          `<option value="${m.id}">${m.name}</option>`
        ).join('');
      });

      document.getElementById('checkoutModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('checkoutModal').classList.add('hidden');
      document.getElementById('paymentModal').classList.add('hidden');
    }

    document.getElementById('checkoutForm').onsubmit = async (e) => {
      e.preventDefault();
      const quantity = document.getElementById('quantity').value;
      const paymentMethodId = document.getElementById('paymentMethod').value;

      try {
        await api('/api/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: currentProductId, quantity, payment_method_id: paymentMethodId })
        });

        // Ambil order terbaru
        const orders = await api('/api/my-orders');
        const latest = orders[0];
        currentOrderId = latest.id;

        // Tampilkan detail pembayaran
        const methods = await api('/api/admin/payment-methods');
        const method = methods.find(m => m.id == paymentMethodId);
        document.getElementById('paymentDetails').innerHTML = `
          <p><strong>Metode: ${method.name}</strong></p>
          <pre class="whitespace-pre-wrap">${method.details}</pre>
          <p class="mt-2 text-sm text-gray-600">Silakan transfer, lalu upload bukti di bawah.</p>
        `;

        closeModal();
        document.getElementById('paymentModal').classList.remove('hidden');
      } catch (e) {
        alert('Gagal checkout: ' + e.message);
      }
    };

    document.getElementById('proofForm').onsubmit = async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('proofFile');
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('proof', file);

      try {
        const res = await fetch(`/api/upload-proof/${currentOrderId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
          body: formData
        });
        if (res.ok) {
          alert('Bukti berhasil diupload! Menunggu konfirmasi admin.');
          closeModal();
          init(); // refresh
        } else {
          const err = await res.json();
          alert('Gagal upload: ' + (err.error || 'Error tidak diketahui'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // Jalankan saat halaman dimuat
    window.onload = init;
  </script>
</body>
</html>
